apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: dex
helmCharts:
- name: dex
  releaseName: dex
  version: 0.13.0
  repo: https://charts.dexidp.io
  valuesInline:
    image:
      tag: v2.35.3
    envVars:
    - name: GITHUB_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: github-client
          key: client-id
    - name: GITHUB_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: github-client
          key: client-secret
    - name: KIALI_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: github-client
          key: kiali-secret
    config:
      issuer: https://dex.diegoluisi.eti.br
      storage:
        type: memory
      # enablePasswordDB: true
      connectors:
      - type: github
        # Required field for connector id.
        id: github
        # Required field for connector name.
        name: GitHub
        config:
          # Credentials can be string literals or pulled from the environment.
          clientID: $GITHUB_CLIENT_ID
          clientSecret: $GITHUB_CLIENT_SECRET
          redirectURI: https://dex.diegoluisi.eti.br/callback
          orgs:
          - name: devxp-tech
            teams:
            - sre-team
          loadAllGroups: false
          teamNameField: slug
          useLoginAsID: false
      staticClients:
      - id: example-app
        redirectURIs:
        - 'http://127.0.0.1:5555/callback'
        name: 'Example App'
        secret: ZXhhbXBsZS1hcHAtc2VjcmV0
      - id: kiali-client
        name: 'Kiali'
        redirectURIs:
        - 'https://kiali.diegoluisi.eti.br/kiali'
        SecretEnv: KIALI_CLIENT_SECRET

- name: dex-k8s-authenticator

  releaseName: dex-k8s-authenticator
  version: 0.0.2
  repo: https://charts.sagikazarmark.dev
  valuesInline:
    global:
      config:
        web_path_prefix: /
        debug: true
        clusters:
          - name: diegoluisi.eti.br example "qa.k8s.your.domain.here"
            short_description: "Cluster K8S XPTO"
            description: "Cluster K8S XPTO"
            client_secret: 6sn6i0DXn0ANG4b0nycOnrvbtFi3UQqZxmx
            issuer: https://dex.diegoluisi.eti.br/
            k8s_master_uri: https://api.diegoluisi.eti.br
            client_id: dex-k8s-authenticator
            redirect_uri: https://kubelogin.your.domain.here/callback/