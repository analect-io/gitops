apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: monitoring
helmCharts:
- name: grafana
  includeCRDs: true
  releaseName: grafana
  version: 6.35.0
  repo: https://grafana.github.io/helm-charts
  valuesInline:
    fullnameOverride: grafana
    grafana.ini:
      server:
        domain: grafana.diegoluisi.eti.br
    admin:
      ## Name of the secret. Can be templated.
      existingSecret: "grafana-secrets"
      userKey: GF_SECURITY_ADMIN_USER
      passwordKey: GF_SECURITY_ADMIN_PASSWORD
    envValueFrom:
      GF_AUTH_GITHUB_CLIENT_ID:
        secretKeyRef:
          name: grafana-secrets
          key: GF_AUTH_GITHUB_CLIENT_ID
      GF_AUTH_GITHUB_CLIENT_SECRET:
        secretKeyRef:
          name: grafana-secrets
          key: GF_AUTH_GITHUB_CLIENT_SECRET
    env:
      # GF_INSTALL_PLUGINS: grafana-simple-json-datasource,alexanderzobnin-zabbix-app
      GF_SERVER_DOMAIN: grafana.diegoluisi.eti.br
      GF_SERVER_ROOT_URL: "https://grafana.diegoluisi.eti.br"
      GF_AUTH_GITHUB_ENABLED: true
      GF_AUTH_GITHUB_ALLOW_SIGN_UP: true
      GF_AUTH_GITHUB_SCOPES: 'user:email,read:org'
      GF_AUTH_GITHUB_ALLOWED_ORGANIZATIONS: devxp-tech
      GF_AUTO_ASSIGN_ORG_ROLE: Admin
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-server
          access: proxy
          isDefault: true
        - name: Alertmanager
          type: alertmanager
          url: http://alertmanager:9093
          access: proxy
          implementation: Prometheus
        - name: Loki
          uid: loki
          type: loki
          access: proxy
          url: http://loki:3100
          version: 1
    dashboards:
      default:
        k8s_views_global-kubernetes-views-global:
          datasource: Prometheus
          url: https://raw.githubusercontent.com/devxp-tech/grafana-dashboards/main/dashboards/k8s_views_global-kubernetes-views-global.json
          # gitlabToken: ''
        k8s_views_nodes-kubernetes-views-nodes.json:
          datasource: Prometheus
          url: https://github.com/devxp-tech/grafana-dashboards/blob/main/dashboards/k8s_views_nodes-kubernetes-views-nodes.json
          # gitlabToken: ''
    notifiers:
      notifiers.yaml:
        notifiers:
          - name: prometheus-alertmanager
            type: prometheus-alertmanager
            uid: prometheus-alertmanager
            org_id: 1
            is_default: true
            settings:
              url: http://prometheus-alertmanager
        delete_notifiers: []